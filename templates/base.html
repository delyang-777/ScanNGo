<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>ScanNGo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

    <!-- ðŸŒ GLOBAL FONT SIZE LOADER -->
    <script>
        window.onload = function () {
            {% if current_user.is_authenticated %}
                let userSize = "{{ current_user.font_size or 'medium' }}";
                let fontMap = {small: '14px', medium: '16px', large: '18px', xlarge: '20px'};
                document.documentElement.style.fontSize = fontMap[userSize] || '16px';
            {% else %}
                let savedSize = localStorage.getItem("globalFontSize");
                if (savedSize) document.documentElement.style.fontSize = savedSize;
            {% endif %}
        };
        function setGlobalFontSize(size) {
            document.documentElement.style.fontSize = size;
            localStorage.setItem("globalFontSize", size);
        }
    </script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: 'Orbitron', sans-serif; background: #0f0f1f; color: #6a6767ff; font-size: 1rem; }
        body, input, select, textarea, button, h1,h2,h3,h4,h5,h6,p,li,a { font-size: 1em; }
        body { display: flex; flex-direction: column; }

        header {
            text-align: center;
            padding: 10px 5px;
            background: #0a0a1a;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
            flex: 0 0 auto;
        }
        header h1 { font-size: 1.6em; color: #00f6ff; text-shadow: 0 0 6px #00f6ff, 0 0 10px #00fff6; }
        header p { font-size: 0.75em; margin-top: 3px; }
        a { color: #00f6ff; font-weight: bold; text-decoration: none; transition: 0.3s; }
        a:hover { color: #00fff6; text-shadow: 0 0 4px #00fff6; }

        main {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            background: rgba(15, 15, 31, 0.95);
            padding: 10px;
            border-radius: 10px;
            margin: 5px;
            box-shadow: 0 0 15px rgba(0,255,255,0.3), inset 0 0 20px rgba(0,255,255,0.1);
            overflow: hidden;
        }

        ul { list-style: none; padding: 0; margin-bottom: 5px; max-height: 30%; overflow-y: auto; }
        li { background: rgba(218, 229, 229, 1); border-left: 3px solid #00f6ff; padding: 5px; margin-bottom: 5px; border-radius: 3px; box-shadow: 0 0 3px rgba(0,255,255,0.2); }
        li strong { color: #00f6ff; }

        input, select, textarea, button {
            font-size: 1em; 
            padding: 6px;
            margin-bottom: 6px;
            border-radius: 5px;
            border: 1px solid #00f6ff;
            background: #0f0f1f;
            color: #e8e2e2ff;
            box-shadow: 0 0 3px rgba(0,246,255,0.3);
        }
        input:focus, select:focus, textarea:focus { border-color: #00fff6; box-shadow: 0 0 6px #00fff6; outline: none; }

        button {
            background: linear-gradient(135deg, #00f6ff, #00fff6);
            color: #0f0f1f;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 0 6px #00f6ff, inset 0 0 10px #00fff6;
            cursor: pointer;
        }
        button:hover { box-shadow: 0 0 8px #00fff6, inset 0 0 12px #00f6ff; }

        .dashboard-card, .register-container {
            background: rgba(15,15,31,0.95);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0,255,255,0.2);
            margin-bottom: 6px;
        }

        #qr-scanner { display:none; text-align:center; margin-top:20px; }
        #qr-scanner video { border:2px solid #00f6ff; border-radius:8px; max-width: 100%; }
        #qr-scanner p { color:#0ff; font-weight:bold; margin-top:6px; }

        @media (max-width: 600px) {
            button { padding: 8px 16px; font-size: 0.9em; }
        }
    </style>
</head>

<body>
<header>
    <h1>ScanNGo</h1>
    {% if current_user.is_authenticated %}
        <p>Logged in as <strong>{{ current_user.username }}</strong> ({{ current_user.role }})</p>
    {% else %}
        <p><a href="{{ url_for('login') }}">Login</a> | <a href="{{ url_for('register') }}">Register</a></p>
    {% endif %}
</header>

<main>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul>
                {% for cat, msg in messages %}
                    <li><strong>{{ cat }}</strong>: {{ msg }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}

    <!-- QR Scanner Modal -->
    <div id="qr-scanner">
        <video id="preview" width="100%" height="300"></video>
        <p id="qr-result"></p>
        <button id="close-scanner" class="neon-btn" style="margin-top:10px;">Close Scanner</button>
    </div>
</main>

<!-- QR Scanner Script -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
document.getElementById('scan-qr-btn')?.addEventListener('click', function() {
    const scannerDiv = document.getElementById('qr-scanner');
    const resultP = document.getElementById('qr-result');
    scannerDiv.style.display = 'block';

    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            stream.getTracks().forEach(track => track.stop()); // just checking access
            const html5QrCode = new Html5Qrcode("preview");

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250, disableFlip: false },
                qrCodeMessage => {
                    resultP.innerText = "QR Code Scanned: " + qrCodeMessage;

                    fetch('/admin/members/checkin', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ qr_data: qrCodeMessage })
                    })
                    .then(res => res.json())
                    .then(data => { 
                        alert(data.message); 
                        html5QrCode.stop(); 
                        scannerDiv.style.display = 'none';
                        resultP.innerText = "";
                    })
                    .catch(err => console.error(err));
                },
                errorMessage => { console.log("QR Scan Error:", errorMessage); }
            );

            document.getElementById('close-scanner').addEventListener('click', function() {
                html5QrCode.stop().then(() => {
                    scannerDiv.style.display = 'none';
                    resultP.innerText = "";
                }).catch(err => console.error(err));
            });
        })
        .catch(err => {
            alert("Camera access denied or blocked. Please allow camera permissions and close overlays from other apps.");
            console.error("Camera access error:", err);
        });
});
</script>
</body>
</html>

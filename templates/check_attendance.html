{% extends 'base.html' %}

{% block content %}
<div style="
    width: 100%;
    margin: 0 auto;
    padding: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
">

    <!-- Fixed Header -->
    <div style="
        position: fixed; top: 0; left: 0; right: 0;
        display: flex; align-items: center; gap: 12px;
        padding: 12px 16px;
        background: rgba(15,15,31,0.95);
        box-shadow: 0 2px 8px rgba(0,255,255,0.3);
        z-index: 999;
    ">
        <a href="{{ url_for('admin_dashboard') }}" class="back-btn">&#8592;</a>
        <h2 style="color:#00f6ff; margin:0; font-size:1.1rem;">Check Attendance</h2>
    </div>

    <!-- Spacer -->
    <div style="height: 70px;"></div>

    <div style="margin-bottom: 20px;">
        <label for="role" style="display: block; font-weight: bold; margin-bottom: 5px;">Select Event:</label>
        <select id="events" name="events" required
                style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                <!-- Event options here -->
        </select>
    </div>

    <!-- Buttons -->
    <div style="padding: 0 10px; margin-bottom: 10px;">
        <div style="
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        ">
            <a href="{{ url_for('export_attendance', file_type='excel') }}" class="neon-btn" style="flex: 1 1 45%; text-align:center;">Export to Excel</a>
            <a href="{{ url_for('export_attendance', file_type='pdf') }}" class="neon-btn" target="_blank" style="flex: 1 1 45%; text-align:center;">Export to PDF</a>
            <button id="scan-qr-btn" class="neon-btn" style="flex: 1 1 100%; text-align:center;">Scan QR</button>
        </div>
    </div>

    <!-- Table -->
    <div style="
        flex: 1;
        overflow-y: auto;
        padding: 0 10px;
        max-height: calc(100vh - 160px);
    ">
        <div style="overflow-x:auto; width:100%;">
            <table style="
                width:100%;
                border-collapse: collapse;
                min-width: 600px;
                font-size: 0.9rem;
                color:#fff;
            ">
                <thead>
                    <tr style="background:#00f6ff; color:#0f0f1f; position:sticky; top:0;">
                        <th style="padding:8px;">ID</th>
                        <th style="padding:8px;">Name</th>
                        <th style="padding:8px;">Checked At</th>
                    </tr>
                </thead>

                <tbody>
                    {% for record in records %}
                    <tr style="border-bottom:1px solid #00f6ff33;">
                        <td style="padding:8px;">{{ record.user_id }}</td>
                        <td style="padding:8px;">{{ record.userName }}</td>
                        <td style="padding:8px;">{{ record.checked_at }}</td>
                    </tr>
                    {% else %}
                    <tr id="records-display">
                        <td colspan="3" style="text-align:center; color:#aaa; padding:15px;">No records found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="qr-scanner" style="
        display:none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 20px;
        justify-content: center;
    ">
        <div id="preview" style="
            width: 100%;
            max-width: 380px;
            height: 60vh;
            border: 2px solid #00fff6;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 15px #00fff6;
        "></div>

        <p id="qr-result" style="color:#0ff; font-size:1rem; text-align:center;">Initializing scanner...</p>
        <button id="close-scanner" class="neon-btn" style="width: 90%;">Close</button>
    </div>

</div>

<style>
.neon-btn {
    background: linear-gradient(135deg, #00ff85, #00d4ff);
    color:#0f0f1f;
    font-weight:bold;
    padding:10px;
    border-radius:12px;
    border:none;
    box-shadow:0 0 6px #00ff85, inset 0 0 10px #00d4ff;
    cursor:pointer;
    font-size:0.9rem;
}
.neon-btn:active { transform: scale(0.97); }

.back-btn {
    padding: 6px 10px;
    background: linear-gradient(135deg,#00f6ff,#00fff6);
    color:#0f0f1f;
    border-radius:20px;
    text-decoration:none;
    box-shadow:0 0 5px #00f6ff;
    font-size:1rem;
}

#preview video {
    width:100% !important;
    height:100% !important;
    object-fit:cover !important;
}
</style>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const events = document.getElementById(events)
let scanner = null;

// fetch event
document.addEventListener("DOMContentLoaded", async function () {
    try {
        const response = await fetch("/fetch_events", {
            method: 'GET',
            headers: {
                'Content-Type' : 'application/json'
            },
        })

        const result = await response.json()
        
        result.forEach(event => {
            // events.app
            // naa pa ko e add diring dapita HAHAHA
        })
    } catch (err) {
        console.error(`Ann error occurs ${err}`)
    }
})

// Beep sound
function playBeep() {
    const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    audio.play();
}

function parse_decode(decode)
{
    const parts = decode.split(",");
    const data = {};
    parts.forEach(part => {
        const [key, value] = part.split(":");
        data[key] = value;
    });
    return data;
}

document.getElementById("scan-qr-btn").addEventListener("click", function () {
    const modal = document.getElementById("qr-scanner");
    const qrResult = document.getElementById("qr-result");
    const previewBox = document.getElementById("preview");
    const records = document.getElementById("records-display");

    modal.style.display = "flex";
    qrResult.innerText = "Initializing camera...";

    scanner = new Html5Qrcode("preview");

    previewBox.style.boxShadow = "0 0 20px #00fff6";

    scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },

        function(decoded) {
            playBeep();
            if (navigator.vibrate) navigator.vibrate(150);

            qrResult.innerText = "Scanned: " + decoded;

            scanner.stop()
            // .then(() => {
            //    return scanner.clear().catch(()=>{});
            // })
            .then(() => {
                scanner = null;
                modal.style.display = "none";
                previewBox.style.boxShadow = "";
                // qrResult.innerText = "";
                fetch("/scan_qr", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ qr_data: parse_decode(decoded) })
                })
                .then(r => r.json())
                .then(data => {
                    alert(data.full_name + " " + data.email);
                    records.innerHTML = "";
                    records.innerHTML = `
                        <td colspan="1" style="text-align:center; color:#aaa; padding:15px;">${data.id}</td>
                        <td colspan="1" style="text-align:center; color:#aaa; padding:15px;">${data.full_name}</td>
                        <td colspan="1" style="text-align:center; color:#aaa; padding:15px;">${data.email}</td>
                    `;
                })
                .catch(err => {
                    console.error("Scanner/Fetch error:", err);
                    // ensure modal gets closed and scanner cleared on error
                    try { scanner && scanner.clear(); } catch(e){}
                    scanner = null;
                    modal.style.display = "none";
                });
            });
        },

        function(error) { }
    )
    .then(() => {
        qrResult.innerText = "Align QR code in the box";
        previewBox.style.boxShadow = "0 0 12px #00fff6, inset 0 0 20px #00fff6";
    })
    .catch(() => {
        qrResult.innerText = "Camera failed. Check permissions.";
    });
});

// Close scanner
document.getElementById("close-scanner").addEventListener("click", function () {
    const modal = document.getElementById("qr-scanner");
    const previewBox = document.getElementById("preview");
    if (scanner) {
        scanner.stop().catch(()=>{}).finally(() => {
            try { scanner.clear(); } catch(e) {}
            scanner = null;
        });
    }
    // previewBox.style.boxShadow = "";
    modal.style.display = "none";
});
</script>

{% endblock %}

{% extends 'base.html' %}

{% block content %}
<div style="
    width: 100%;
    margin: 0 auto;
    padding: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
">

    <!-- Fixed Header -->
    <div style="
        position: fixed; top: 0; left: 0; right: 0;
        display: flex; align-items: center; gap: 12px;
        padding: 12px 16px;
        background: rgba(15,15,31,0.95);
        box-shadow: 0 2px 8px rgba(0,255,255,0.3);
        z-index: 999;
    ">
        <a href="{{ url_for('admin_dashboard') }}" class="back-btn">&#8592;</a>
        <h2 style="color:#00f6ff; margin:0; font-size:1.1rem;">Check Attendance</h2>
    </div>

    <!-- Spacer -->
    <div style="height: 70px;"></div>

    <div style="margin-bottom: 20px;">
        <label for="role" style="display: block; font-weight: bold; margin-bottom: 5px;">Select Event:</label>
        <select id="events" name="events" required
                style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                <!-- Event options here -->
        </select>
    </div>

    <!-- Buttons -->
    <div style="padding: 0 10px; margin-bottom: 10px;">
        <div style="
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        ">
            <button id="export-excel-btn" class="neon-btn" style="flex: 1 1 45%; text-align:center;">Export to Excel</button>
            <button id="export-pdf-btn" class="neon-btn" style="flex: 1 1 45%; text-align:center;">Export to PDF</button>
            <button id="scan-qr-btn" class="neon-btn" style="flex: 1 1 100%; text-align:center;">Scan QR</button>
        </div>
    </div>

    <!-- Table -->
    <div style="
        flex: 1;
        overflow-y: auto;
        padding: 0 10px;
        max-height: calc(100vh - 160px);
    ">
        <div style="overflow-x:auto; width:100%;">
            <table style="
                width:100%;
                border-collapse: collapse;
                min-width: 600px;
                font-size: 0.9rem;
                color:#fff;
            ">
                <thead>
                    <tr style="background:#00f6ff; color:#0f0f1f; position:sticky; top:0;">
                        <th style="padding:8px;">ID</th>
                        <th style="padding:8px;">Full Name</th>
                        <th style="padding:8px;">Age</th>
                        <th style="padding:8px;">Year Level</th>
                        <th style="padding:8px;">Status</th>
                        <th style="padding:8px;">Citizenship</th>
                        <th style="padding:8px;">Address</th>
                        <th style="padding:8px;">Place of Birth</th>
                        <th style="padding:8px;">Checked At</th>
                    </tr>
                </thead>

                <tbody>
                    <tr id="records-display">
                        <td colspan="9" style="text-align:center; color:#aaa; padding:15px;">Please select an event to view attendance.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div id="qr-scanner" style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        z-index: 1000;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        padding: 20px;
        justify-content: center;
    ">
        <div id="preview" style="
            width: 100%;
            max-width: 380px;
            height: 60vh;
            border: 2px solid #00fff6;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 15px #00fff6;
        "></div>

        <p id="qr-result" style="color:#0ff; font-size:1rem; text-align:center;">Initializing scanner...</p>
        <button id="close-scanner" class="neon-btn" style="width: 90%;">Close</button>
    </div>

</div>

<style>
.neon-btn {
    background: linear-gradient(135deg, #00ff85, #00d4ff);
    color:#0f0f1f;
    font-weight:bold;
    padding:10px;
    border-radius:12px;
    border:none;
    box-shadow:0 0 6px #00ff85, inset 0 0 10px #00d4ff;
    cursor:pointer;
    font-size:0.9rem;
}
.neon-btn:active { transform: scale(0.97); }

.back-btn {
    padding: 6px 10px;
    background: linear-gradient(135deg,#00f6ff,#00fff6);
    color:#0f0f1f;
    border-radius:20px;
    text-decoration:none;
    box-shadow:0 0 5px #00f6ff;
    font-size:1rem;
}

#preview video {
    width:100% !important;
    height:100% !important;
    object-fit:cover !important;
}
</style>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const events = document.getElementById("events");
let scanner = null;

// fetch event
document.addEventListener("DOMContentLoaded", async function () {
    try {
        const response = await fetch("/fetch_events", {
            method: 'GET',
            headers: {
                'Content-Type' : 'application/json'
            },
        })

        const result = await response.json()
        
        // Clear existing options first
        events.innerHTML = '<option value="">-- Select an Event --</option>';
        
        result.forEach(event => {
            const option = document.createElement('option');
            option.value = event.id; // or event.event_id depending on your API response
            option.textContent = event.title; // or event.event_name depending on your API response
            events.appendChild(option);
        })
    } catch (err) {
        console.error(`Ann error occurs ${err}`)
    }
})

// Fetch attendance when event is selected
events.addEventListener('change', async function() {
    const eventId = this.value;
    if (!eventId) {
        // Clear table if no event selected
        const tbody = document.querySelector('tbody');
        tbody.innerHTML = '<tr id="records-display"><td colspan="3" style="text-align:center; color:#aaa; padding:15px;">Please select an event.</td></tr>';
        return;
    }

    try {
        const response = await fetch(`/fetch_attendance_by_event/${eventId}`);
        const records = await response.json();
        
        const tbody = document.querySelector('tbody');
        tbody.innerHTML = '';
        
        if (records.length === 0) {
            tbody.innerHTML = '<tr id="records-display"><td colspan="9" style="text-align:center; color:#aaa; padding:15px;">No attendance records for this event.</td></tr>';
        } else {
            records.forEach(record => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #00f6ff33';
                row.innerHTML = `
                    <td style="padding:8px;">${record.user_id}</td>
                    <td style="padding:8px;">${record.full_name || 'N/A'}</td>
                    <td style="padding:8px;">${record.age || 'N/A'}</td>
                    <td style="padding:8px;">${record.year_level || 'N/A'}</td>
                    <td style="padding:8px;">${record.status || 'N/A'}</td>
                    <td style="padding:8px;">${record.citizenship || 'N/A'}</td>
                    <td style="padding:8px;">${record.address || 'N/A'}</td>
                    <td style="padding:8px;">${record.place_of_birth || 'N/A'}</td>
                    <td style="padding:8px;">${record.checked_at}</td>
                `;
                tbody.appendChild(row);
            });
        }
    } catch (err) {
        console.error('Error fetching attendance:', err);
        alert('Failed to fetch attendance records');
    }
});

// Beep sound
function playBeep() {
    const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    audio.play();
}

function parse_decode(decode)
{
    const parts = decode.split(",");
    const data = {};
    parts.forEach(part => {
        const [key, value] = part.split(":");
        data[key] = value;
    });
    return data;
}

document.getElementById("scan-qr-btn").addEventListener("click", async function () {
    const modal = document.getElementById("qr-scanner");
    const qrResult = document.getElementById("qr-result");
    const previewBox = document.getElementById("preview");
    const records = document.getElementById("records-display");

    // Check if an event is selected
    const selectedEventId = events.value;
    if (!selectedEventId) {
        alert('Please select an event first before scanning QR codes!');
        return;
    }

    // Check if site is secure (HTTPS or localhost)
    const isSecure = window.location.protocol === 'https:' || 
                     window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1';
    
    if (!isSecure) {
        alert('Camera access requires HTTPS connection!\n\nYou are currently on HTTP. Please:\n1. Access via https:// instead of http://\n2. Or use localhost/127.0.0.1 for testing');
        return;
    }

    modal.style.display = "flex";
    qrResult.innerText = "Initializing camera...";

    try {
        scanner = new Html5Qrcode("preview");
        previewBox.style.boxShadow = "0 0 20px #00fff6";

        // Get available cameras
        const devices = await Html5Qrcode.getCameras();
        
        if (!devices || devices.length === 0) {
            throw new Error("No cameras found on this device");
        }

        // Use the back camera if available, otherwise use first camera
        const cameraId = devices.length > 1 ? devices[devices.length - 1].id : devices[0].id;
        
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        };
        
        await scanner.start(
            cameraId,
            config,

        function(decoded) {
            playBeep();
            if (navigator.vibrate) navigator.vibrate(150);

            qrResult.innerText = "Scanned: " + decoded;

            scanner.stop()
            // .then(() => {
            //    return scanner.clear().catch(()=>{});
            // })
            .then(() => {
                scanner = null;
                modal.style.display = "none";
                previewBox.style.boxShadow = "";
                
                const selectedEventId = events.value;
                if (!selectedEventId) {
                    alert('Please select an event first!');
                    return;
                }
                
                fetch("/scan_qr", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        qr_data: parse_decode(decoded),
                        event_id: selectedEventId
                    })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    alert(`Attendance recorded: ${data.full_name}`);
                    
                    // Refresh the attendance list for the selected event
                    events.dispatchEvent(new Event('change'));
                })
                .catch(err => {
                    console.error("Scanner/Fetch error:", err);
                    alert('Failed to record attendance');
                    // ensure modal gets closed and scanner cleared on error
                    try { scanner && scanner.clear(); } catch(e){}
                    scanner = null;
                    modal.style.display = "none";
                });
            });
        },

        function(error) { 
            // Ignore decode errors during scanning
        }
        );
        
        qrResult.innerText = "Align QR code in the box";
        previewBox.style.boxShadow = "0 0 12px #00fff6, inset 0 0 20px #00fff6";
        
    } catch (err) {
        console.error("Camera error:", err);
        qrResult.innerText = "Camera failed: " + err.message;
        
        let errorMsg = "Unable to access camera.\n\n";
        if (err.name === 'NotAllowedError' || err.message.includes('Permission')) {
            errorMsg += "Camera permission was denied. Please:\n1. Click the camera icon in your browser's address bar\n2. Allow camera access\n3. Reload the page and try again";
        } else if (err.name === 'NotFoundError' || err.message.includes('No cameras')) {
            errorMsg += "No camera found on this device.\nPlease ensure your device has a working camera.";
        } else if (err.name === 'NotReadableError') {
            errorMsg += "Camera is already in use by another application.\nPlease close other apps using the camera and try again.";
        } else if (err.name === 'OverconstrainedError') {
            errorMsg += "Camera doesn't meet requirements.\nTrying with different settings...";
        } else {
            errorMsg += "Error: " + err.message + "\n\nPlease:\n1. Check camera permissions\n2. Ensure HTTPS connection (required for camera access)\n3. Try a different browser";
        }
        
        alert(errorMsg);
        modal.style.display = "none";
        if (scanner) {
            try { scanner.clear(); } catch(e) {}
        }
        scanner = null;
    }
});

// Close scanner
document.getElementById("close-scanner").addEventListener("click", function () {
    const modal = document.getElementById("qr-scanner");
    const previewBox = document.getElementById("preview");
    if (scanner) {
        scanner.stop().catch(()=>{}).finally(() => {
            try { scanner.clear(); } catch(e) {}
            scanner = null;
        });
    }
    // previewBox.style.boxShadow = "";
    modal.style.display = "none";
});

// Export to Excel
document.getElementById("export-excel-btn").addEventListener("click", function() {
    const eventId = events.value;
    if (!eventId) {
        alert('Please select an event first!');
        return;
    }
    window.location.href = `/export_attendance/excel/${eventId}`;
});

// Export to PDF
document.getElementById("export-pdf-btn").addEventListener("click", function() {
    const eventId = events.value;
    if (!eventId) {
        alert('Please select an event first!');
        return;
    }
    window.open(`/export_attendance/pdf/${eventId}`, '_blank');
});
</script>

{% endblock %}
